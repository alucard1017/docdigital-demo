const express=require('express');const multer=require('multer');const path=require('path');const db=require('../db');const{requireAuth}=require('./auth');const router=express.Router();const storage=multer.diskStorage({destination:(req,file,cb)=>cb(null,path.join(__dirname,'..','uploads')),filename:(req,file,cb)=>{const ext=path.extname(file.originalname);cb(null,Date.now()+'-'+Math.round(Math.random()*1e9)+ext);}});const upload=multer({storage});router.get('/',requireAuth,(req,res)=>{db.all('SELECT * FROM documents WHERE owner_id=? ORDER BY created_at DESC',[req.user.id],(err,rows)=>{if(err)return res.status(500).json({error:'DB error'});res.json(rows);});});router.post('/',requireAuth,upload.single('file'),(req,res)=>{const{title,description}=req.body;if(!req.file)return res.status(400).json({error:'PDF requerido'});const filePath='/uploads/'+req.file.filename;const now=new Date().toISOString();db.run('INSERT INTO documents (owner_id,title,description,file_path,status,created_at,updated_at) VALUES (?,?,?,?,?,?,?)',[req.user.id,title,description,filePath,'PENDIENTE',now,now],function(err){if(err)return res.status(500).json({error:'DB error'});db.get('SELECT * FROM documents WHERE id=?',[this.lastID],(e,row)=>{if(e)return res.status(500).json({error:'DB error'});res.status(201).json(row);});});});router.post('/:id/firmar',requireAuth,(req,res)=>{const id=req.params.id;const now=new Date().toISOString();db.run('UPDATE documents SET status=?, updated_at=? WHERE id=? AND owner_id=?',['FIRMADO',now,id,req.user.id],function(err){if(err)return res.status(500).json({error:'DB error'});if(!this.changes)return res.status(404).json({error:'No encontrado'});db.get('SELECT * FROM documents WHERE id=?',[id],(e,row)=>{if(e)return res.status(500).json({error:'DB error'});res.json(row);});});});router.post('/:id/rechazar',requireAuth,(req,res)=>{const id=req.params.id;const{motivo}=req.body;if(!motivo)return res.status(400).json({error:'Motivo requerido'});const now=new Date().toISOString();db.run('UPDATE documents SET status=?, reject_reason=?, updated_at=? WHERE id=? AND owner_id=?',['RECHAZADO',motivo,now,id,req.user.id],function(err){if(err)return res.status(500).json({error:'DB error'});if(!this.changes)return res.status(404).json({error:'No encontrado'});db.get('SELECT * FROM documents WHERE id=?',[id],(e,row)=>{if(e)return res.status(500).json({error:'DB error'});res.json(row);});});});module.exports=router;